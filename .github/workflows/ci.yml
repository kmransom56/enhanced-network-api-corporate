name: Corporate Network API - CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8
    
    - name: Lint with flake8
      run: |
        flake8 src/enhanced_network_api --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/enhanced_network_api --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Format check with black
      run: |
        black --check src/enhanced_network_api
    
    - name: Test corporate network compatibility validation
      run: |
        python src/enhanced_network_api/validate_corporate_network_compatibility.py || true
    
    - name: Test SSL helper functionality
      run: |
        python -c "from src.enhanced_network_api.ssl_helper import CorporateSSLHelper; print('SSL helper imported successfully')"
    
    - name: Test network helper functionality  
      run: |
        python -c "from src.enhanced_network_api.corporate_network_helper import CorporateNetworkHelper; print('Network helper imported successfully')"
    
    - name: Test API documentation loading
      run: |
        python -c "from src.enhanced_network_api.api_documentation_loader import APIDocumentationLoader; print('API loader imported successfully')"
        
    - name: Validate API documentation integrity
      run: |
        python -c "
        import json
        from pathlib import Path
        api_file = Path('api/fortimanager_api_endpoints.json')
        if api_file.exists():
            with open(api_file) as f:
                data = json.load(f)
            print(f'✅ FortiManager API: {data.get(\"total_endpoints\", 0)} endpoints')
        else:
            print('⚠️  FortiManager API file not found')
        "

  corporate-compatibility:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run corporate compatibility validation
      run: |
        python src/enhanced_network_api/validate_corporate_network_compatibility.py || echo "Corporate compatibility validation completed"
    
    - name: Test SSL certificate discovery
      run: |
        python -c "
        from src.enhanced_network_api.certificate_discovery import CorporateCertificateDiscovery
        discovery = CorporateCertificateDiscovery()
        print('✅ Certificate discovery module functional')
        "
    
    - name: Test deployment packaging
      run: |
        python -c "
        from src.enhanced_network_api.corporate_deployment_packager import CorporateDeploymentPackager
        packager = CorporateDeploymentPackager()
        print('✅ Corporate deployment packager functional')
        "

  air-gapped-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test air-gapped deployment creation
      run: |
        python -c "
        from src.enhanced_network_api.air_gapped_deployment import AirGappedDeployment
        deployment = AirGappedDeployment('./test-airgapped')
        print('✅ Air-gapped deployment module functional')
        "

  build-package:
    runs-on: ubuntu-latest
    needs: [test, corporate-compatibility, air-gapped-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        twine check dist/*
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install security scan tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        pip install -r requirements.txt
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/enhanced_network_api/ -f json -o bandit-report.json || true
    
    - name: Run Safety check
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: "*-report.json"